<head>
  <title>WeTracker</title>
  <link rel="stylesheet" type="text/css" href="sanitize.css">
  <link rel="stylesheet" type="text/css" href="styles.css">
  <script
    src="https://code.jquery.com/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js"></script>
  <script src="doT.js"></script>
</head>

<body>
  <div id="container">
    <div class="pattern-editor">
      <div style="float: left;">
        <div>
          <div>
            <table id="timeline-header">
              <thead>
                <tr class="row">
                  <th class="tick">
                    <div class="time-header" style="height: 55px;"><br /></div>
                  </th>
                </tr>
              </thead>
            </table>
          </div>

          <div class="timeline" style="height: 210px;">
          </div>
        </div>
      </div>

      <div style="float: left; width: calc(150 * 7);" class="xscroll">
        <div id="trackheader" class="leftSideTable" style="width: 1070px;">
        </div>
        <div style="height: 210px; width: 1070px;" class="sideTable" onWheel="onScroll(event)">
          <table id="trackview">
          </table>
        </div>
      </div>

    </div>
  </div>

  <script id="timeline-template" type="text/x-handlebars-template">
    <table>
      <tbody>
        <tr class="row">
          <th class="tick">
            <div style="height: calc(7 * 15px)"></div>
          </th>
        </tr>
        {{#each rows}}
          <tr class="row"><th class="tick">{{this}}</th></tr>
        {{/each}}
        <tr class="row">
          <th class="tick">
            <div style="height: calc(7 * 15px);"></div>
          </th>
        </tr>
      </tbody>
    </table>
  </script>

  <script id="header-template" type="text/x-dot-template">
    <table id="header-table">
      <thead>
        <tr>
          {{ for(var track in it.tracks) { }}
          <th>
            <div class="track-header" style="width: {{=it.tracks[track].notecolumns * 150}}px;">
              <span>{{=it.tracks[track].name}}</span>
              <div class="track-color" style="background: {{=it.tracks[track].color}};"></div>
              <div class="track-controls">
                <button>-</button>
                <button>+</button>
              </div>
            </div>
          </th>
          {{ } }}
        </tr>
      </thead>
    </table>
  </script>

  <script id="event-partial" type="text/x-handlebars-template">
    <div class="note">C-4</div>
    <div class="instrument">01</div>
    <div class="volume">40</div>
    <div class="panning">80</div>
    <div class="delay">--</div>
    <div class="fx">----</div>
  </script>

  <script id="trackview-template" type="text/x-dot-template">
    <tbody>
      <tr>
        {{ for(var i = 0; i < 7; ++i) { }}
        <td><div style="height: calc(7 * 15px)"></div></td>
        {{ } }}
      </tr>
      {{ for(var row = 0; row < it.patterns[0].rows; row++ ) { }}
      <tr class="row pattern-cursor-row">
        {{ for(var track in it.tracks) { }}
        <td>
          <div class="line">
            {{ for(var notecol = 0; notecol < it.tracks[track].notecolumns; notecol++) { }}
            <div class="note-column">
              <div class="note">C-4</div>
              <div class="instrument">01</div>
              <div class="volume">40</div>
              <div class="panning">80</div>
              <div class="delay">--</div>
              <div class="fx">----</div>
            </div>
            {{ } }}
          </div>
        </td>
        {{ } }}
      </tr>
      {{ } }}
      <tr>
        {{ for(var i = 0; i < 7; ++i) { }}
        <td><div style="height: calc(7 * 15px)"></div></td>
        {{ } }}
      </tr>
    </tbody>
  </script>

  <script>
  var yoff = 0;
  var theCursor = 0;
  var lastCursor = null;
  var events = document.getElementsByClassName("sideTable")[0];
  var timeline = document.getElementsByClassName("timeline")[0];
  var xscroll = document.getElementsByClassName("xscroll")[0];
  var patternRows = null;
  var timelineRows = null;

  function onScroll(e) {
    if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
      yoff += e.deltaY;
      if (yoff < 0) {
        yoff = events.scrollHeight - events.clientHeight;
      } else if (yoff >= events.scrollHeight - events.clientHeight) {
        yoff = 0;
      }
      theCursor = Math.round((yoff) / 15.0);
    } else {
      xscroll.scrollLeft += e.deltaX;
    }
    e.preventDefault();
  }

  function updateCursor(timestamp) {
    if((!lastCursor) || (lastCursor !== theCursor)) {
      lastCursor = theCursor;
      var offset = theCursor * 15.0;

      timeline.scrollTop = offset;
      events.scrollTop = offset;

      var oldCursorRows = document.querySelectorAll('tr.pattern-cursor-row');
      oldCursorRows.forEach(function(element) {
        element.classList.remove('pattern-cursor-row');
      });

      var timelineRow = timelineRows[theCursor+1];
      var eventsRow = patternRows[theCursor+1];
      timelineRow.classList.add('pattern-cursor-row');
      eventsRow.classList.add('pattern-cursor-row');
    }
    window.requestAnimationFrame(updateCursor);
  }

  window.requestAnimationFrame(updateCursor);

  function play() {
    theCursor += 1;
    if ((theCursor * 15) >= events.scrollHeight - events.clientHeight) {
      theCursor = 0;
    }
  }

  document.addEventListener("DOMContentLoaded", function(event) { 
    Handlebars.registerPartial('event', $('#event-partial').html());

    var timelineContainer = $('.timeline');
    var timeline = {
      rows: [ 
        0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,  
        16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31 
      ]
    };
    var timelineTemplate = Handlebars.compile($('#timeline-template').html());
    timelineContainer.append(timelineTemplate(timeline));

    var song = {
      tracks: [{
        notecolumns: 2,
        fxcolumns: 1,
        name: 'Lead',
        type: 'play',
        color: '#008800',
      }, {
        notecolumns: 2,
        fxcolumns: 1,
        name: 'Bass',
        type: 'play',
        color: '#880000',
      }, {
        notecolumns: 1,
        fxcolumns: 1,
        name: 'Lead1',
        type: 'play',
        color: '#000088',
      }, {
        notecolumns: 1,
        fxcolumns: 1,
        name: 'Pad',
        type: 'play',
        color: '#008888',
      }, {
        notecolumns: 1,
        fxcolumns: 1,
        name: 'Track5',
        type: 'play',
        color: '#880088',
      }, {
        notecolumns: 1,
        fxcolumns: 1,
        name: 'Track 6',
        type: 'play',
        color: '#888800',
      }, {
        notecolumns: 1,
        fxcolumns: 1,
        name: 'Track 7',
        type: 'play',
        color: '#888844',
      }],
      instruments: [
        {
          name: 'piano',
          type: 'sampler',
          samples: [
            {
              url: '/assets/audio/Korg-M3R-Grand-Piano-C1.wav',
              base: 'C1',
              rangeStart: 'C1',
              rangeEnd: 'B2',
            },
            {
              url: '/assets/audio/Korg-M3R-Grand-Piano-C3.wav',
              base: 'C3',
              rangeStart: 'C3',
              rangeEnd: 'B4',
            },
            {
              url: '/assets/audio/Korg-M3R-Grand-Piano-C5.wav',
              base: 'C5',
              rangeStart: 'C5',
              rangeEnd: 'C9',
            },
          ],
          data: {
            envelope: {
              attack: 0.00,
              decay: 2.0,
              sustain: 1.0,
              release: 5.9,
            },
          },
        },
        {
          name: 'buzz',
          type: 'synth',
          data: {
            oscillator: {
              type: 'square',
              modulationFrequency: 0.2,
            },
            envelope: {
              attack: 0.02,
              decay: 0.1,
              sustain: 0.2,
              release: 1.9,
            },
          },
        },
        {
          name: 'tom',
          type: 'membrane',
          data: {
            pitchDecay: 0.008,
            octaves: 2,
            envelope: {
              attack: 0.0006,
              decay: 0.5,
              sustain: 0,
            },
          },
        },
        {
          name: 'cymbal',
          type: 'metal',
          data: {
            harmonicity: 2,
            resonance: 800,
            modulationIndex: 20,
            envelope: {
              decay: 0.8,
            },
            volume: -35,
          },
        },
      ],
      patterns: [{
        rows: 32,
        trackdata: [{
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }, {
          notedata: [
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
            {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {}, {},
          ],
        }],
      }],
    };

    var trackviewTemplate = doT.template(document.getElementById('trackview-template').text);
    document.getElementById('trackview').innerHTML = trackviewTemplate(song);

    var headerTemplate = doT.template(document.getElementById('header-template').text);
    document.getElementById('trackheader').innerHTML = headerTemplate(song);

    patternRows = document.querySelectorAll('#trackview tr');
    timelineRows = document.querySelectorAll('.timeline tr');
  });

  //window.setInterval(play, 6); // 300 bpm at 32 lpb
  
  </script>
</body>

